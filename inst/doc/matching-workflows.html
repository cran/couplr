<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Gilles Colling" />

<meta name="date" content="2026-01-20" />

<title>Matching Workflows</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Matching Workflows</h1>
<h4 class="author">Gilles Colling</h4>
<h4 class="date">2026-01-20</h4>



<div id="overview" class="section level2">
<h2>Overview</h2>
<p>Matching is a fundamental technique for creating comparable groups in
observational studies. Unlike random assignment, observational data
often contain systematic differences between treatment and control
groups that confound causal inference. Matching addresses this by
pairing similar units based on observed characteristics, creating
“apples-to-apples” comparisons.</p>
<p>This vignette follows a <strong>complete workflow</strong> from raw
data to publication-ready results, using a realistic job training
evaluation as the running example. You’ll learn to handle the full
pipeline: preprocessing, matching, assessment, and reporting.</p>
<div id="who-this-vignette-is-for" class="section level3">
<h3>Who This Vignette Is For</h3>
<p><strong>Audience</strong>: Researchers, epidemiologists, economists,
data scientists working with observational data</p>
<p><strong>Prerequisites</strong>:</p>
<ul>
<li><p>Familiarity with basic <code>couplr</code> usage
(<code>vignette(&quot;getting-started&quot;)</code>)</p></li>
<li><p>Understanding of causal inference concepts (treatment effects,
confounding)</p></li>
<li><p>Basic statistics (means, standard deviations, t-tests)</p></li>
</ul>
<p><strong>What You’ll Learn</strong>:</p>
<ul>
<li><p>How to match treatment and control units with
<code>match_couples()</code></p></li>
<li><p>Automatic preprocessing: scaling, health checks, categorical
encoding</p></li>
<li><p>Assessing match quality with
<code>balance_diagnostics()</code></p></li>
<li><p>When to use optimal vs greedy matching</p></li>
<li><p>Creating publication-ready balance tables</p></li>
</ul>
<p><strong>Time to complete</strong>: 30-45 minutes</p>
</div>
<div id="documentation-roadmap" class="section level3">
<h3>Documentation Roadmap</h3>
<table>
<colgroup>
<col width="34%" />
<col width="24%" />
<col width="41%" />
</colgroup>
<thead>
<tr class="header">
<th>Vignette</th>
<th>Focus</th>
<th>Difficulty</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Getting Started</td>
<td>Basic LAP solving, API introduction</td>
<td>Beginner</td>
</tr>
<tr class="even">
<td>Algorithms</td>
<td>Mathematical foundations, solver selection</td>
<td>Intermediate</td>
</tr>
<tr class="odd">
<td><strong>Matching Workflows</strong></td>
<td>Production matching pipelines</td>
<td>Intermediate</td>
</tr>
<tr class="even">
<td>Pixel Morphing</td>
<td>Scientific applications, approximations</td>
<td>Advanced</td>
</tr>
</tbody>
</table>
<p><em>You are here: Matching Workflows</em></p>
</div>
<div id="the-running-example-job-training-evaluation" class="section level3">
<h3>The Running Example: Job Training Evaluation</h3>
<p>Throughout this vignette, we evaluate a <strong>job training
program’s effect on earnings</strong>. The challenge: participants
self-selected into the program, so they differ systematically from
non-participants in age, education, and prior earnings. Without
matching, any earnings difference could be due to these baseline
differences rather than the program itself.</p>
<p><strong>Our goal</strong>: Create comparable treatment and control
groups, assess balance quality, and estimate the treatment effect
credibly.</p>
</div>
<div id="key-features" class="section level3">
<h3>Key Features</h3>
<ul>
<li><p>Automatic preprocessing with health checks and smart
scaling</p></li>
<li><p>Optimal matching via linear assignment algorithms</p></li>
<li><p>Fast greedy matching for large datasets (n &gt; 5,000)</p></li>
<li><p>Blocking and stratification support</p></li>
<li><p>Comprehensive balance diagnostics</p></li>
<li><p>Publication-ready output tables</p></li>
</ul>
</div>
</div>
<div id="problem-definition" class="section level2">
<h2>Problem Definition</h2>
<div id="the-matching-problem" class="section level3">
<h3>The Matching Problem</h3>
<p>Given two groups of units:</p>
<ul>
<li><p><strong>Left group</strong> (treatment, exposed, cases): <span class="math inline">\(n_L\)</span> units</p></li>
<li><p><strong>Right group</strong> (control, unexposed, controls):
<span class="math inline">\(n_R\)</span> units</p></li>
</ul>
<p>Each unit <span class="math inline">\(i\)</span> has a covariate
vector <span class="math inline">\(\mathbf{x}_i \in
\mathbb{R}^p\)</span> describing characteristics we want to balance
(age, income, education, etc.).</p>
<p><strong>Goal:</strong> Find one-to-one matches that minimize total
distance:</p>
<p><span class="math display">\[
\min_{\pi} \sum_{i=1}^{n} d(\mathbf{x}_i^L, \mathbf{x}_{\pi(i)}^R)
\]</span></p>
<p>where <span class="math inline">\(d(\cdot, \cdot)\)</span> is a
distance function (typically Euclidean or Mahalanobis) and <span class="math inline">\(\pi\)</span> is a matching assignment.</p>
</div>
<div id="why-matching-matters" class="section level3">
<h3>Why Matching Matters</h3>
<p><strong>Without matching:</strong></p>
<ul>
<li><p>Groups may differ systematically on important covariates</p></li>
<li><p>Treatment effect estimates are confounded by these
differences</p></li>
<li><p>Statistical adjustments (regression) rely on untestable
assumptions</p></li>
</ul>
<p><strong>With matching:</strong></p>
<ul>
<li><p>Create comparable groups that differ primarily in treatment
status</p></li>
<li><p>Balance covariates to reduce confounding</p></li>
<li><p>Improve causal inference by mimicking randomized
experiments</p></li>
<li><p>Transparent, non-parametric preprocessing step</p></li>
</ul>
</div>
<div id="distance-metrics" class="section level3">
<h3>Distance Metrics</h3>
<p>The quality of matching depends on the distance metric:</p>
<p><strong>Euclidean distance</strong> (after scaling): <span class="math display">\[
d(\mathbf{x}_i, \mathbf{x}_j) = \sqrt{\sum_{k=1}^{p} (x_{ik} -
x_{jk})^2}
\]</span></p>
<p><strong>Mahalanobis distance</strong> (accounts for correlations):
<span class="math display">\[
d(\mathbf{x}_i, \mathbf{x}_j) = \sqrt{(\mathbf{x}_i - \mathbf{x}_j)^\top
\Sigma^{-1} (\mathbf{x}_i - \mathbf{x}_j)}
\]</span></p>
<p><strong>Propensity score distance</strong> (single dimension): <span class="math display">\[
d(i, j) = |p_i - p_j|
\]</span></p>
<p>where <span class="math inline">\(p_i = P(\text{treatment} \mid
\mathbf{x}_i)\)</span> is the propensity score.</p>
<p><code>couplr</code> defaults to Euclidean distance with automatic
scaling, which works well for most applications.</p>
</div>
</div>
<div id="basic-usage" class="section level2">
<h2>Basic Usage</h2>
<div id="creating-a-matched-sample" class="section level3">
<h3>Creating a Matched Sample</h3>
<p>The simplest workflow uses <code>match_couples()</code> with
automatic preprocessing:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Simulate observational data</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>n_left <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>n_right <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co"># Treatment group (tends to be younger, higher income)</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>left_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n_left,</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>  <span class="at">age =</span> <span class="fu">rnorm</span>(n_left, <span class="at">mean =</span> <span class="dv">45</span>, <span class="at">sd =</span> <span class="dv">10</span>),</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>  <span class="at">income =</span> <span class="fu">rnorm</span>(n_left, <span class="at">mean =</span> <span class="dv">60000</span>, <span class="at">sd =</span> <span class="dv">15000</span>),</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>  <span class="at">education =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">&quot;HS&quot;</span>, <span class="st">&quot;BA&quot;</span>, <span class="st">&quot;MA&quot;</span>), n_left, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">&quot;treatment&quot;</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>)</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="co"># Control group (older, lower income on average)</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>right_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n_right,</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  <span class="at">age =</span> <span class="fu">rnorm</span>(n_right, <span class="at">mean =</span> <span class="dv">52</span>, <span class="at">sd =</span> <span class="dv">12</span>),</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>  <span class="at">income =</span> <span class="fu">rnorm</span>(n_right, <span class="at">mean =</span> <span class="dv">50000</span>, <span class="at">sd =</span> <span class="dv">18000</span>),</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>  <span class="at">education =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">&quot;HS&quot;</span>, <span class="st">&quot;BA&quot;</span>, <span class="st">&quot;MA&quot;</span>), n_right, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">&quot;control&quot;</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>)</span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a><span class="co"># Perform optimal matching</span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>  <span class="at">left =</span> left_data,</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>  <span class="at">right =</span> right_data,</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;income&quot;</span>),</span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a>  <span class="at">return_diagnostics =</span> <span class="cn">TRUE</span></span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a>)</span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a><span class="co">#&gt; Auto-selected scaling method: standardize</span></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a><span class="co"># View matched pairs</span></span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a><span class="fu">head</span>(result<span class="sc">$</span>pairs)</span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a><span class="co">#&gt; # A tibble: 6 × 5</span></span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a><span class="co">#&gt;   left_id right_id distance .age_diff .income_diff</span></span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a><span class="co">#&gt; 1 1       27         0.530   -5.68           2942.</span></span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a><span class="co">#&gt; 2 2       37         0.299    3.33            980.</span></span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a><span class="co">#&gt; 3 3       15         0.0382  -0.251          -512.</span></span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a><span class="co">#&gt; 4 4       11         0.691   -7.19           4587.</span></span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a><span class="co">#&gt; 5 5       73         0.425   -4.48           2583.</span></span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a><span class="co">#&gt; 6 6       131        0.133    0.00187       -2186.</span></span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a>result<span class="sc">$</span>info</span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a><span class="co">#&gt; $solver</span></span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a><span class="co">#&gt; [1] &quot;auction_scaled&quot;</span></span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-51"><a href="#cb1-51" tabindex="-1"></a><span class="co">#&gt; $n_matched</span></span>
<span id="cb1-52"><a href="#cb1-52" tabindex="-1"></a><span class="co">#&gt; [1] 100</span></span>
<span id="cb1-53"><a href="#cb1-53" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-54"><a href="#cb1-54" tabindex="-1"></a><span class="co">#&gt; $total_distance</span></span>
<span id="cb1-55"><a href="#cb1-55" tabindex="-1"></a><span class="co">#&gt; [1] 33.77392</span></span>
<span id="cb1-56"><a href="#cb1-56" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-57"><a href="#cb1-57" tabindex="-1"></a><span class="co">#&gt; $method</span></span>
<span id="cb1-58"><a href="#cb1-58" tabindex="-1"></a><span class="co">#&gt; [1] &quot;lap&quot;</span></span>
<span id="cb1-59"><a href="#cb1-59" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-60"><a href="#cb1-60" tabindex="-1"></a><span class="co">#&gt; $distance_metric</span></span>
<span id="cb1-61"><a href="#cb1-61" tabindex="-1"></a><span class="co">#&gt; [1] &quot;euclidean&quot;</span></span>
<span id="cb1-62"><a href="#cb1-62" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-63"><a href="#cb1-63" tabindex="-1"></a><span class="co">#&gt; $scaled</span></span>
<span id="cb1-64"><a href="#cb1-64" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span>
<span id="cb1-65"><a href="#cb1-65" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-66"><a href="#cb1-66" tabindex="-1"></a><span class="co">#&gt; $n_left</span></span>
<span id="cb1-67"><a href="#cb1-67" tabindex="-1"></a><span class="co">#&gt; [1] 100</span></span>
<span id="cb1-68"><a href="#cb1-68" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-69"><a href="#cb1-69" tabindex="-1"></a><span class="co">#&gt; $n_right</span></span>
<span id="cb1-70"><a href="#cb1-70" tabindex="-1"></a><span class="co">#&gt; [1] 150</span></span></code></pre></div>
<p>The result contains:</p>
<ul>
<li><p><code>pairs</code>: Matched pairs with IDs and distances</p></li>
<li><p><code>info</code>: Matching method, counts, total
distance</p></li>
<li><p><code>left_unmatched</code>, <code>right_unmatched</code>: Units
without matches</p></li>
<li><p><code>cost_matrix</code>: Full distance matrix (if
<code>return_diagnostics = TRUE</code>)</p></li>
</ul>
</div>
<div id="understanding-the-output" class="section level3">
<h3>Understanding the Output</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># How many matched?</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Matched pairs:&quot;</span>, result<span class="sc">$</span>info<span class="sc">$</span>n_matched, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co">#&gt; Matched pairs: 100</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Unmatched left:&quot;</span>, <span class="fu">nrow</span>(result<span class="sc">$</span>left_unmatched), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">#&gt; Unmatched left:</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Unmatched right:&quot;</span>, <span class="fu">nrow</span>(result<span class="sc">$</span>right_unmatched), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co">#&gt; Unmatched right:</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co"># Distribution of match distances</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="fu">summary</span>(result<span class="sc">$</span>pairs<span class="sc">$</span>distance)</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="co">#&gt; 0.002044 0.139855 0.249548 0.337739 0.466174 1.939711</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="co"># Visualize match quality</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="fu">ggplot</span>(result<span class="sc">$</span>pairs, <span class="fu">aes</span>(<span class="at">x =</span> distance)) <span class="sc">+</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">&quot;#29abe0&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Distribution of Match Distances&quot;</span>,</span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Euclidean Distance (scaled)&quot;</span>,</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Count&quot;</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>        <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img role="img" aria-label="Histogram showing the distribution of match distances, with most matches having low distances indicating good match quality" src="data:image/png;base64,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" alt="Histogram showing the distribution of match distances, with most matches having low distances indicating good match quality" /></p>
<p><strong>Interpretation:</strong></p>
<ul>
<li><p>Lower distances indicate better matches (more similar
units)</p></li>
<li><p>Median distance provides typical match quality</p></li>
<li><p>Large distances suggest poor matches (consider caliper
constraints)</p></li>
</ul>
</div>
</div>
<div id="automatic-preprocessing" class="section level2">
<h2>Automatic Preprocessing</h2>
<div id="why-preprocessing-matters" class="section level3">
<h3>Why Preprocessing Matters</h3>
<p>Raw covariates often have:</p>
<ul>
<li><p><strong>Different scales</strong>: Age in years (20-80), income
in dollars (20,000-200,000)</p></li>
<li><p><strong>Different units</strong>: Continuous (age), categorical
(education), binary (smoker)</p></li>
<li><p><strong>Data quality issues</strong>: Missing values, constant
variables, extreme outliers</p></li>
</ul>
<p>Without preprocessing, high-variance variables dominate distance
calculations.</p>
</div>
<div id="smart-scaling-with-auto_scale-true" class="section level3">
<h3>Smart Scaling with <code>auto_scale = TRUE</code></h3>
<p>When <code>auto_scale = TRUE</code>, <code>match_couples()</code>
automatically:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Detects problematic variables</strong></p>
<ul>
<li><p>Constant variables (SD = 0) → excluded with warning</p></li>
<li><p>High missingness (&gt;50%) → warned</p></li>
<li><p>Extreme skewness (|skew| &gt; 2) → informed</p></li>
</ul></li>
<li><p><strong>Applies appropriate scaling</strong></p>
<ul>
<li><p>Continuous variables → scaled by selected method</p></li>
<li><p>Binary variables (0/1) → used as-is</p></li>
<li><p>Categorical → converted to numeric if ordered</p></li>
</ul></li>
<li><p><strong>Handles categorical variables</strong></p>
<ul>
<li><p>Unordered factors → converted to binary indicators</p></li>
<li><p>Ordered factors → converted to numeric ranks</p></li>
</ul></li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Create data with scaling challenges</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">456</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>challenging_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>,</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  <span class="at">age =</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">10</span>),                    <span class="co"># Years (reasonable scale)</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  <span class="at">income =</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="dv">60000</span>, <span class="dv">20000</span>),           <span class="co"># Dollars (large scale)</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="at">bmi =</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="dv">25</span>, <span class="dv">5</span>),                     <span class="co"># Ratio (small scale)</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>  <span class="at">smoker =</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">50</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),   <span class="co"># Binary</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  <span class="at">education =</span> <span class="fu">factor</span>(</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>    <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">&quot;HS&quot;</span>, <span class="st">&quot;BA&quot;</span>, <span class="st">&quot;MA&quot;</span>, <span class="st">&quot;PhD&quot;</span>), <span class="dv">50</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>    <span class="at">ordered =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>    <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;HS&quot;</span>, <span class="st">&quot;BA&quot;</span>, <span class="st">&quot;MA&quot;</span>, <span class="st">&quot;PhD&quot;</span>)</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>  )</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>)</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>left_chal <span class="ot">&lt;-</span> challenging_data[<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>, ]</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>right_chal <span class="ot">&lt;-</span> challenging_data[<span class="dv">26</span><span class="sc">:</span><span class="dv">50</span>, ]</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="co"># Match WITHOUT auto-scaling (income dominates)</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>result_no_scale <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>  left_chal, right_chal,</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;income&quot;</span>, <span class="st">&quot;bmi&quot;</span>),</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">FALSE</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>)</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co"># Match WITH auto-scaling (all variables contribute)</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>result_scaled <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>  left_chal, right_chal,</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;income&quot;</span>, <span class="st">&quot;bmi&quot;</span>),</span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>  <span class="at">scale =</span> <span class="st">&quot;robust&quot;</span>  <span class="co"># Median/MAD scaling (robust to outliers)</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>)</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a><span class="co"># Compare match quality</span></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Without scaling - mean distance:&quot;</span>, <span class="fu">mean</span>(result_no_scale<span class="sc">$</span>pairs<span class="sc">$</span>distance), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a><span class="co">#&gt; Without scaling - mean distance: 3572.096</span></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;With scaling - mean distance:&quot;</span>, <span class="fu">mean</span>(result_scaled<span class="sc">$</span>pairs<span class="sc">$</span>distance), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a><span class="co">#&gt; With scaling - mean distance: 0.9784372</span></span></code></pre></div>
</div>
<div id="scaling-methods" class="section level3">
<h3>Scaling Methods</h3>
<p>Three scaling strategies available via <code>scale</code>
parameter:</p>
<p><strong>1. Robust scaling</strong> (<code>scale = &quot;robust&quot;</code>,
default): <span class="math display">\[
x_{\text{scaled}} = \frac{x - \text{median}(x)}{\text{MAD}(x)}
\]</span></p>
<ul>
<li><p>Uses median and median absolute deviation (MAD)</p></li>
<li><p>Resistant to outliers and skewness</p></li>
<li><p>Best for: Real-world data with potential outliers</p></li>
</ul>
<p><strong>2. Standardization</strong>
(<code>scale = &quot;standardize&quot;</code>): <span class="math display">\[
x_{\text{scaled}} = \frac{x - \text{mean}(x)}{\text{SD}(x)}
\]</span></p>
<ul>
<li><p>Classical z-score normalization</p></li>
<li><p>Assumes approximate normality</p></li>
<li><p>Best for: Clean, normally-distributed data</p></li>
</ul>
<p><strong>3. Range scaling</strong> (<code>scale = &quot;range&quot;</code>):
<span class="math display">\[
x_{\text{scaled}} = \frac{x - \min(x)}{\max(x) - \min(x)}
\]</span></p>
<ul>
<li><p>Scales to [0, 1] range</p></li>
<li><p>Preserves exact relationships</p></li>
<li><p>Best for: Bounded variables, visualization</p></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Demonstrate scaling methods</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>demo_var <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">100</span>)  <span class="co"># Contains outlier (100)</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co"># Function to show scaling</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>show_scaling <span class="ot">&lt;-</span> <span class="cf">function</span>(x, method) {</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  left_demo <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">var =</span> x[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>  right_demo <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">var =</span> x[<span class="dv">4</span><span class="sc">:</span><span class="dv">5</span>])</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    left_demo, right_demo,</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    <span class="at">vars =</span> <span class="st">&quot;var&quot;</span>,</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    <span class="at">auto_scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    <span class="at">scale =</span> method,</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    <span class="at">return_diagnostics =</span> <span class="cn">TRUE</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>  )</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>  <span class="co"># Extract scaled values from cost matrix</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>  <span class="fu">cat</span>(method, <span class="st">&quot;scaling:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;  Original:&quot;</span>, x, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;  Distance matrix diagonal:&quot;</span>, <span class="fu">diag</span>(result<span class="sc">$</span>cost_matrix)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>}</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="fu">show_scaling</span>(demo_var, <span class="st">&quot;robust&quot;</span>)</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="co">#&gt; robust scaling:</span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a><span class="co">#&gt;   Original: 10 20 25 30 100 </span></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a><span class="co">#&gt;   Distance matrix diagonal: NA NA</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a><span class="fu">show_scaling</span>(demo_var, <span class="st">&quot;standardize&quot;</span>)</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a><span class="co">#&gt; standardize scaling:</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a><span class="co">#&gt;   Original: 10 20 25 30 100 </span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a><span class="co">#&gt;   Distance matrix diagonal: NA NA</span></span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a><span class="fu">show_scaling</span>(demo_var, <span class="st">&quot;range&quot;</span>)</span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a><span class="co">#&gt; range scaling:</span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a><span class="co">#&gt;   Original: 10 20 25 30 100 </span></span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a><span class="co">#&gt;   Distance matrix diagonal: NA NA</span></span></code></pre></div>
</div>
<div id="health-checks-and-warnings" class="section level3">
<h3>Health Checks and Warnings</h3>
<p>The preprocessing system provides informative diagnostics:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Create data with issues</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>problematic_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="at">age =</span> <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">10</span>),</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  <span class="at">constant_var =</span> <span class="dv">5</span>,                           <span class="co"># No variation - will warn</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="at">mostly_missing =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">10</span>), <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">80</span>)),  <span class="co"># &gt;50% missing</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  <span class="at">extreme_skew =</span> <span class="fu">rexp</span>(<span class="dv">100</span>, <span class="at">rate =</span> <span class="fl">0.1</span>)       <span class="co"># Very skewed</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co"># Attempt matching - will show warnings</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>  problematic_data[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, ],</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>  problematic_data[<span class="dv">51</span><span class="sc">:</span><span class="dv">100</span>, ],</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;constant_var&quot;</span>, <span class="st">&quot;mostly_missing&quot;</span>, <span class="st">&quot;extreme_skew&quot;</span>),</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">TRUE</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>)</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="co"># Warning messages will indicate:</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a><span class="co"># - &quot;constant_var excluded (SD = 0)&quot;</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="co"># - &quot;mostly_missing has 80% missing values&quot;</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a><span class="co"># - &quot;extreme_skew has high skewness (3.2)&quot;</span></span></code></pre></div>
</div>
</div>
<div id="optimal-vs-greedy-matching" class="section level2">
<h2>Optimal vs Greedy Matching</h2>
<p>For large datasets (n &gt; 5,000), optimal matching becomes
computationally expensive. <code>couplr</code> provides fast greedy
alternatives.</p>
<div id="when-to-use-each-approach" class="section level3">
<h3>When to Use Each Approach</h3>
<p><strong>Optimal matching</strong>
(<code>method = &quot;optimal&quot;</code>):</p>
<ul>
<li><p>Minimizes total distance (globally optimal solution)</p></li>
<li><p>Uses linear assignment algorithms (<span class="math inline">\(O(n^3)\)</span> complexity)</p></li>
<li><p>Suitable for: n &lt; 5,000, when optimality is critical</p></li>
<li><p>Typical runtime: &lt;1 second for n=1,000, ~10 seconds for
n=3,000</p></li>
</ul>
<p><strong>Greedy matching</strong>
(<code>method = &quot;greedy&quot;</code>):</p>
<ul>
<li><p>Fast approximation (10-100x faster)</p></li>
<li><p>Three strategies: sorted, row_best, pq</p></li>
<li><p>Suitable for: n &gt; 5,000, exploratory analysis, when speed
matters</p></li>
<li><p>Typical runtime: &lt;1 second for n=10,000</p></li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Create moderately large dataset</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">789</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>large_left <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">rnorm</span>(n),</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">rnorm</span>(n),</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>  <span class="at">x3 =</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>large_right <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">rnorm</span>(n),</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">rnorm</span>(n),</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>  <span class="at">x3 =</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>)</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="co"># Optimal matching</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>time_optimal <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>  result_optimal <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>    large_left, large_right,</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;x1&quot;</span>, <span class="st">&quot;x2&quot;</span>, <span class="st">&quot;x3&quot;</span>),</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;hungarian&quot;</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>  )</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>})</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a><span class="co"># Greedy matching (row_best strategy)</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>time_greedy <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>  result_greedy <span class="ot">&lt;-</span> <span class="fu">greedy_couples</span>(</span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>    large_left, large_right,</span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>    <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;x1&quot;</span>, <span class="st">&quot;x2&quot;</span>, <span class="st">&quot;x3&quot;</span>),</span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>    <span class="at">strategy =</span> <span class="st">&quot;row_best&quot;</span></span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>  )</span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>})</span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a><span class="co"># Compare</span></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Optimal matching:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a><span class="co">#&gt; Optimal matching:</span></span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Time:&quot;</span>, <span class="fu">round</span>(time_optimal[<span class="st">&quot;elapsed&quot;</span>], <span class="dv">3</span>), <span class="st">&quot;seconds</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a><span class="co">#&gt;   Time: 162.73 seconds</span></span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Mean distance:&quot;</span>, <span class="fu">round</span>(<span class="fu">mean</span>(result_optimal<span class="sc">$</span>pairs<span class="sc">$</span>distance), <span class="dv">4</span>), <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a><span class="co">#&gt;   Mean distance: 0.3368</span></span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Greedy matching:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a><span class="co">#&gt; Greedy matching:</span></span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Time:&quot;</span>, <span class="fu">round</span>(time_greedy[<span class="st">&quot;elapsed&quot;</span>], <span class="dv">3</span>), <span class="st">&quot;seconds</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a><span class="co">#&gt;   Time: 1.58 seconds</span></span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Mean distance:&quot;</span>, <span class="fu">round</span>(<span class="fu">mean</span>(result_greedy<span class="sc">$</span>pairs<span class="sc">$</span>distance), <span class="dv">4</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a><span class="co">#&gt;   Mean distance: 0.4667</span></span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Speedup:&quot;</span>, <span class="fu">round</span>(time_optimal[<span class="st">&quot;elapsed&quot;</span>] <span class="sc">/</span> time_greedy[<span class="st">&quot;elapsed&quot;</span>], <span class="dv">1</span>), <span class="st">&quot;x</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a><span class="co">#&gt;   Speedup: 103 x</span></span></code></pre></div>
</div>
<div id="greedy-strategies" class="section level3">
<h3>Greedy Strategies</h3>
<p>Three greedy strategies available via
<code>greedy_couples()</code>:</p>
<p><strong>1. Sorted</strong> (<code>strategy = &quot;sorted&quot;</code>):</p>
<ul>
<li><p>Sort all possible pairs by distance</p></li>
<li><p>Assign greedily from best to worst</p></li>
<li><p>Best quality among greedy methods</p></li>
<li><p>Slowest greedy option (still much faster than optimal)</p></li>
</ul>
<pre><code>Algorithm:
1. Compute all n_L × n_R distances

2. Sort pairs by distance (ascending)

3. For each pair in sorted order:

   - If both units unmatched, assign them

4. Stop when no more matches possible</code></pre>
<p><strong>2. Row-best</strong> (<code>strategy = &quot;row_best&quot;</code>,
default):</p>
<ul>
<li><p>For each left unit, find best available right unit</p></li>
<li><p>Process left units in order</p></li>
<li><p>Fast and simple</p></li>
<li><p>Medium quality</p></li>
</ul>
<pre><code>Algorithm:
1. For i = 1 to n_L:

   - Find unmatched right unit j with minimum distance to i

   - Assign (i, j)

2. Return all assignments</code></pre>
<p><strong>3. Priority queue</strong>
(<code>strategy = &quot;pq&quot;</code>):</p>
<ul>
<li><p>Maintains priority queue of potential matches</p></li>
<li><p>Updates dynamically as assignments made</p></li>
<li><p>Best for very large problems</p></li>
<li><p>Fastest option</p></li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># Compare greedy strategies on same data</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">101</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>test_left <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">200</span>))</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>test_right <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">200</span>))</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>strategies <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sorted&quot;</span>, <span class="st">&quot;row_best&quot;</span>, <span class="st">&quot;pq&quot;</span>)</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="cf">for</span> (strat <span class="cf">in</span> strategies) {</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>  time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">greedy_couples</span>(</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>      test_left, test_right,</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>      <span class="at">vars =</span> <span class="st">&quot;x&quot;</span>,</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>      <span class="at">strategy =</span> strat</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>    )</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>  })</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>  results[[strat]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>    <span class="at">time =</span> time[<span class="st">&quot;elapsed&quot;</span>],</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>    <span class="at">mean_dist =</span> <span class="fu">mean</span>(result<span class="sc">$</span>pairs<span class="sc">$</span>distance),</span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    <span class="at">total_dist =</span> result<span class="sc">$</span>info<span class="sc">$</span>total_distance</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>  )</span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>}</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="co"># Display comparison</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">names</span>(results), <span class="cf">function</span>(s) {</span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>    <span class="at">strategy =</span> s,</span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>    <span class="at">time_sec =</span> <span class="fu">round</span>(results[[s]]<span class="sc">$</span>time, <span class="dv">4</span>),</span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>    <span class="at">mean_distance =</span> <span class="fu">round</span>(results[[s]]<span class="sc">$</span>mean_dist, <span class="dv">4</span>),</span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>    <span class="at">total_distance =</span> <span class="fu">round</span>(results[[s]]<span class="sc">$</span>total_dist, <span class="dv">2</span>)</span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a>  )</span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a>}))</span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a><span class="fu">print</span>(comparison)</span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a><span class="co">#&gt;          strategy time_sec mean_distance total_distance</span></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a><span class="co">#&gt; elapsed    sorted     0.07        0.0912          18.24</span></span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a><span class="co">#&gt; elapsed1 row_best     0.04        0.0968          19.36</span></span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a><span class="co">#&gt; elapsed2       pq     0.04        0.0912          18.24</span></span></code></pre></div>
<p><strong>Recommendation:</strong></p>
<ul>
<li><p>Default to <code>strategy = &quot;row_best&quot;</code> for good
speed/quality balance</p></li>
<li><p>Use <code>strategy = &quot;sorted&quot;</code> when quality is important
but optimal is too slow</p></li>
<li><p>Use <code>strategy = &quot;pq&quot;</code> for n &gt; 10,000</p></li>
</ul>
</div>
</div>
<div id="caliper-constraints" class="section level2">
<h2>Caliper Constraints</h2>
<p>Calipers impose maximum allowable match distances to ensure minimum
quality.</p>
<div id="why-use-calipers" class="section level3">
<h3>Why Use Calipers</h3>
<p>Without calipers, optimal matching may pair very dissimilar units
just to maximize the number of matches. Calipers prevent this by:</p>
<ul>
<li><p>Setting a distance threshold beyond which matches are
forbidden</p></li>
<li><p>Reducing the number of matches to improve average
quality</p></li>
<li><p>Implementing the “common support” requirement in propensity score
matching</p></li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># Create data where some units are far apart</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">202</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>left_cal <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>,</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="dv">40</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>), <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="at">mean =</span> <span class="dv">5</span>, <span class="at">sd =</span> <span class="fl">0.5</span>))  <span class="co"># Some outliers</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>)</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>right_cal <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>,</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>)</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="co"># Match without caliper - pairs everything</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>result_no_cal <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>  left_cal, right_cal,</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>  <span class="at">vars =</span> <span class="st">&quot;x&quot;</span>,</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">FALSE</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>)</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a><span class="co"># Match with caliper - excludes poor matches</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>result_with_cal <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>  left_cal, right_cal,</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>  <span class="at">vars =</span> <span class="st">&quot;x&quot;</span>,</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>  <span class="at">max_distance =</span> <span class="fl">1.5</span>,  <span class="co"># Caliper: max distance = 1.5</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">FALSE</span></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>)</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Without caliper:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a><span class="co">#&gt; Without caliper:</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Matched:&quot;</span>, result_no_cal<span class="sc">$</span>info<span class="sc">$</span>n_matched, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a><span class="co">#&gt;   Matched: 50</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Mean distance:&quot;</span>, <span class="fu">round</span>(<span class="fu">mean</span>(result_no_cal<span class="sc">$</span>pairs<span class="sc">$</span>distance), <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a><span class="co">#&gt;   Mean distance: 1.129</span></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Max distance:&quot;</span>, <span class="fu">round</span>(<span class="fu">max</span>(result_no_cal<span class="sc">$</span>pairs<span class="sc">$</span>distance), <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a><span class="co">#&gt;   Max distance: 5.453</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;With caliper (1.5):</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a><span class="co">#&gt; With caliper (1.5):</span></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Matched:&quot;</span>, result_with_cal<span class="sc">$</span>info<span class="sc">$</span>n_matched, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a><span class="co">#&gt;   Matched: 40</span></span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Mean distance:&quot;</span>, <span class="fu">round</span>(<span class="fu">mean</span>(result_with_cal<span class="sc">$</span>pairs<span class="sc">$</span>distance), <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a><span class="co">#&gt;   Mean distance: 0.143</span></span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Max distance:&quot;</span>, <span class="fu">round</span>(<span class="fu">max</span>(result_with_cal<span class="sc">$</span>pairs<span class="sc">$</span>distance), <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a><span class="co">#&gt;   Max distance: 0.763</span></span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a><span class="co"># Visualize caliper effect</span></span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a><span class="fu">ggplot</span>(result_no_cal<span class="sc">$</span>pairs, <span class="fu">aes</span>(<span class="at">x =</span> distance)) <span class="sc">+</span></span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">fill =</span> <span class="st">&quot;No caliper&quot;</span>), <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a>    <span class="at">data =</span> result_with_cal<span class="sc">$</span>pairs,</span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> <span class="st">&quot;With caliper&quot;</span>),</span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">30</span>,</span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-54"><a href="#cb10-54" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">1.5</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb10-55"><a href="#cb10-55" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb10-56"><a href="#cb10-56" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Caliper Effect on Match Distances&quot;</span>,</span>
<span id="cb10-57"><a href="#cb10-57" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Distance&quot;</span>,</span>
<span id="cb10-58"><a href="#cb10-58" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Count&quot;</span>,</span>
<span id="cb10-59"><a href="#cb10-59" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;Condition&quot;</span></span>
<span id="cb10-60"><a href="#cb10-60" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-61"><a href="#cb10-61" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb10-62"><a href="#cb10-62" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb10-63"><a href="#cb10-63" tabindex="-1"></a>        <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb10-64"><a href="#cb10-64" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb10-65"><a href="#cb10-65" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img role="img" aria-label="Overlapping histograms comparing match distances with and without caliper constraint, showing the caliper excludes distant matches" src="data:image/png;base64,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" alt="Overlapping histograms comparing match distances with and without caliper constraint, showing the caliper excludes distant matches" /></p>
</div>
<div id="choosing-caliper-width" class="section level3">
<h3>Choosing Caliper Width</h3>
<p>Common approaches:</p>
<p><strong>1. Standard deviation rule</strong>: Caliper = 0.1 to 0.25
pooled SD</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Calculate pooled SD</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>combined <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  left_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">&quot;left&quot;</span>),</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  right_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">&quot;right&quot;</span>)</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>)</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>pooled_sd <span class="ot">&lt;-</span> <span class="fu">sd</span>(combined<span class="sc">$</span>age)  <span class="co"># For single variable</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>caliper_width <span class="ot">&lt;-</span> <span class="fl">0.2</span> <span class="sc">*</span> pooled_sd</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  left_data, right_data,</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  <span class="at">vars =</span> <span class="st">&quot;age&quot;</span>,</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>  <span class="at">max_distance =</span> caliper_width</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>)</span></code></pre></div>
<p><strong>2. Propensity score rule</strong>: 0.1 to 0.25 SD of
propensity score logit</p>
<p><strong>3. Empirical rule</strong>: Examine distance distribution,
exclude extreme tail</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Fit all matches first</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>all_matches <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(left_cal, right_cal, <span class="at">vars =</span> <span class="st">&quot;x&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co"># Choose caliper at 90th percentile</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>caliper_90 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(all_matches<span class="sc">$</span>pairs<span class="sc">$</span>distance, <span class="fl">0.90</span>)</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="co"># Refit with caliper</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>refined_matches <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>  left_cal, right_cal,</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  <span class="at">vars =</span> <span class="st">&quot;x&quot;</span>,</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  <span class="at">max_distance =</span> caliper_90</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>)</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;90th percentile caliper:&quot;</span>, <span class="fu">round</span>(caliper_90, <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a><span class="co">#&gt; 90th percentile caliper: 4.532</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Matches retained:&quot;</span>,</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>    <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> refined_matches<span class="sc">$</span>info<span class="sc">$</span>n_matched <span class="sc">/</span> all_matches<span class="sc">$</span>info<span class="sc">$</span>n_matched, <span class="dv">1</span>), <span class="st">&quot;%</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a><span class="co">#&gt; Matches retained: 100 %</span></span></code></pre></div>
</div>
</div>
<div id="blocking-and-stratification" class="section level2">
<h2>Blocking and Stratification</h2>
<p>Blocking (exact matching on key variables) combined with distance
matching on remaining covariates is a powerful strategy.</p>
<div id="why-use-blocking" class="section level3">
<h3>Why Use Blocking</h3>
<p><strong>Benefits:</strong></p>
<ul>
<li><p>Ensures exact balance on critical variables (site, gender, age
category)</p></li>
<li><p>Reduces problem size (smaller within-block matching
problems)</p></li>
<li><p>Prevents poor cross-block matches</p></li>
<li><p>Transparent and interpretable</p></li>
</ul>
<p><strong>When to use:</strong></p>
<ul>
<li><p>Strong domain knowledge about important stratification
variables</p></li>
<li><p>Variables that absolutely must be balanced (e.g., study site in
multi-center trials)</p></li>
<li><p>Large datasets where blocking reduces computational
burden</p></li>
</ul>
</div>
<div id="exact-blocking-with-matchmaker" class="section level3">
<h3>Exact Blocking with <code>matchmaker()</code></h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Create multi-site data</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">303</span>)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>multi_site <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>    <span class="at">site =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>), <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">10</span>),</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="at">income =</span> <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="dv">55000</span>, <span class="dv">15000</span>),</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">&quot;treatment&quot;</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>  ),</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">101</span><span class="sc">:</span><span class="dv">250</span>,</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>    <span class="at">site =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>), <span class="dv">150</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">rnorm</span>(<span class="dv">150</span>, <span class="dv">50</span>, <span class="dv">10</span>),</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>    <span class="at">income =</span> <span class="fu">rnorm</span>(<span class="dv">150</span>, <span class="dv">55000</span>, <span class="dv">15000</span>),</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">&quot;control&quot;</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>  )</span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>)</span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>left_site <span class="ot">&lt;-</span> multi_site <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">&quot;treatment&quot;</span>)</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>right_site <span class="ot">&lt;-</span> multi_site <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">&quot;control&quot;</span>)</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a><span class="co"># Create exact blocks by site</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>blocks <span class="ot">&lt;-</span> <span class="fu">matchmaker</span>(</span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>  <span class="at">left =</span> left_site,</span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>  <span class="at">right =</span> right_site,</span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a>  <span class="at">block_type =</span> <span class="st">&quot;group&quot;</span>,</span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a>  <span class="at">block_by =</span> <span class="st">&quot;site&quot;</span></span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a>)</span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Blocking structure:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a><span class="co">#&gt; Blocking structure:</span></span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a><span class="fu">print</span>(blocks<span class="sc">$</span>block_summary)</span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 3</span></span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a><span class="co">#&gt;   block_id n_left n_right</span></span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb13-37"><a href="#cb13-37" tabindex="-1"></a><span class="co">#&gt; 1 A            36      58</span></span>
<span id="cb13-38"><a href="#cb13-38" tabindex="-1"></a><span class="co">#&gt; 2 B            26      42</span></span>
<span id="cb13-39"><a href="#cb13-39" tabindex="-1"></a><span class="co">#&gt; 3 C            38      50</span></span>
<span id="cb13-40"><a href="#cb13-40" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" tabindex="-1"></a><span class="co"># Match within blocks</span></span>
<span id="cb13-42"><a href="#cb13-42" tabindex="-1"></a>result_blocked <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb13-43"><a href="#cb13-43" tabindex="-1"></a>  <span class="at">left =</span> blocks<span class="sc">$</span>left,</span>
<span id="cb13-44"><a href="#cb13-44" tabindex="-1"></a>  <span class="at">right =</span> blocks<span class="sc">$</span>right,</span>
<span id="cb13-45"><a href="#cb13-45" tabindex="-1"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;income&quot;</span>),</span>
<span id="cb13-46"><a href="#cb13-46" tabindex="-1"></a>  <span class="at">block_id =</span> <span class="st">&quot;block_id&quot;</span>,  <span class="co"># Use block IDs from matchmaker</span></span>
<span id="cb13-47"><a href="#cb13-47" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">TRUE</span></span>
<span id="cb13-48"><a href="#cb13-48" tabindex="-1"></a>)</span>
<span id="cb13-49"><a href="#cb13-49" tabindex="-1"></a><span class="co">#&gt; Auto-selected scaling method: standardize</span></span>
<span id="cb13-50"><a href="#cb13-50" tabindex="-1"></a></span>
<span id="cb13-51"><a href="#cb13-51" tabindex="-1"></a><span class="co"># Verify exact site balance</span></span>
<span id="cb13-52"><a href="#cb13-52" tabindex="-1"></a>result_blocked<span class="sc">$</span>pairs <span class="sc">%&gt;%</span></span>
<span id="cb13-53"><a href="#cb13-53" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">left_id =</span> <span class="fu">as.integer</span>(left_id), <span class="at">right_id =</span> <span class="fu">as.integer</span>(right_id)) <span class="sc">%&gt;%</span></span>
<span id="cb13-54"><a href="#cb13-54" tabindex="-1"></a>  <span class="fu">left_join</span>(left_site <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(id, site), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;left_id&quot;</span> <span class="ot">=</span> <span class="st">&quot;id&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-55"><a href="#cb13-55" tabindex="-1"></a>  <span class="fu">left_join</span>(right_site <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(id, site), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;right_id&quot;</span> <span class="ot">=</span> <span class="st">&quot;id&quot;</span>), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">&quot;_left&quot;</span>, <span class="st">&quot;_right&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-56"><a href="#cb13-56" tabindex="-1"></a>  <span class="fu">count</span>(site_left, site_right)</span>
<span id="cb13-57"><a href="#cb13-57" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 3</span></span>
<span id="cb13-58"><a href="#cb13-58" tabindex="-1"></a><span class="co">#&gt;   site_left site_right     n</span></span>
<span id="cb13-59"><a href="#cb13-59" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;      &lt;int&gt;</span></span>
<span id="cb13-60"><a href="#cb13-60" tabindex="-1"></a><span class="co">#&gt; 1 A         A             36</span></span>
<span id="cb13-61"><a href="#cb13-61" tabindex="-1"></a><span class="co">#&gt; 2 B         B             26</span></span>
<span id="cb13-62"><a href="#cb13-62" tabindex="-1"></a><span class="co">#&gt; 3 C         C             38</span></span></code></pre></div>
</div>
<div id="cluster-based-blocking" class="section level3">
<h3>Cluster-Based Blocking</h3>
<p>For continuous variables, use k-means clustering to create
blocks:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># Create blocks based on age groups (data-driven)</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>cluster_blocks <span class="ot">&lt;-</span> <span class="fu">matchmaker</span>(</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>  <span class="at">left =</span> left_site,</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  <span class="at">right =</span> right_site,</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  <span class="at">block_type =</span> <span class="st">&quot;cluster&quot;</span>,</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>  <span class="at">block_vars =</span> <span class="st">&quot;age&quot;</span>,</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="at">n_blocks =</span> <span class="dv">3</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>)</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Cluster-based blocks:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="co">#&gt; Cluster-based blocks:</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="fu">print</span>(cluster_blocks<span class="sc">$</span>block_summary)</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 4</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a><span class="co">#&gt;   block_id  n_left n_right mean_age</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a><span class="co">#&gt; 1 cluster_1     37      56     61.2</span></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a><span class="co">#&gt; 2 cluster_2     41      65     48.4</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a><span class="co">#&gt; 3 cluster_3     22      29     37.9</span></span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a><span class="co"># Match within clusters</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>result_clustered <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>  <span class="at">left =</span> cluster_blocks<span class="sc">$</span>left,</span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>  <span class="at">right =</span> cluster_blocks<span class="sc">$</span>right,</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;income&quot;</span>),</span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>  <span class="at">block_id =</span> <span class="st">&quot;block_id&quot;</span>,</span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">TRUE</span></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a>)</span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a><span class="co">#&gt; Auto-selected scaling method: standardize</span></span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a><span class="co"># Show age distribution by cluster</span></span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a>cluster_blocks<span class="sc">$</span>left <span class="sc">%&gt;%</span></span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a>  <span class="fu">group_by</span>(block_id) <span class="sc">%&gt;%</span></span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a>    <span class="at">mean_age =</span> <span class="fu">mean</span>(age),</span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a>    <span class="at">sd_age =</span> <span class="fu">sd</span>(age)</span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a>  )</span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 4</span></span>
<span id="cb14-39"><a href="#cb14-39" tabindex="-1"></a><span class="co">#&gt;   block_id      n mean_age sd_age</span></span>
<span id="cb14-40"><a href="#cb14-40" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;     &lt;int&gt;    &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb14-41"><a href="#cb14-41" tabindex="-1"></a><span class="co">#&gt; 1 cluster_1    37     61.2   4.59</span></span>
<span id="cb14-42"><a href="#cb14-42" tabindex="-1"></a><span class="co">#&gt; 2 cluster_2    41     48.4   3.27</span></span>
<span id="cb14-43"><a href="#cb14-43" tabindex="-1"></a><span class="co">#&gt; 3 cluster_3    22     37.9   4.42</span></span></code></pre></div>
</div>
</div>
<div id="balance-diagnostics" class="section level2">
<h2>Balance Diagnostics</h2>
<p>After matching, assess balance quality using
<code>balance_diagnostics()</code>.</p>
<div id="key-balance-metrics" class="section level3">
<h3>Key Balance Metrics</h3>
<p><strong>1. Standardized differences:</strong> <span class="math display">\[
\text{Std Diff} = \frac{\bar{x}_{\text{left}} -
\bar{x}_{\text{right}}}{\sqrt{(s_{\text{left}}^2 + s_{\text{right}}^2) /
2}}
\]</span></p>
<p><strong>Thresholds:</strong></p>
<ul>
<li><p>&lt; 0.1: Excellent balance</p></li>
<li><p>0.1 - 0.25: Good balance</p></li>
<li><p>0.25 - 0.5: Acceptable (may need further adjustment)</p></li>
<li><blockquote>
<p>0.5: Poor balance (reconsider matching strategy)</p>
</blockquote></li>
</ul>
<p><strong>2. Variance ratios:</strong> <span class="math display">\[
\text{VR} = \frac{s_{\text{left}}^2}{s_{\text{right}}^2}
\]</span></p>
<p><strong>Interpretation:</strong></p>
<ul>
<li><p>Close to 1.0: Similar variability (good)</p></li>
<li><p>&lt; 0.5 or &gt; 2.0: Concerning imbalance in spread</p></li>
</ul>
<p><strong>3. Kolmogorov-Smirnov tests:</strong></p>
<ul>
<li><p>Non-parametric test for distributional differences</p></li>
<li><p>Sensitive to differences beyond mean/variance</p></li>
<li><p>P-value &gt; 0.05 suggests similar distributions</p></li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># Perform matching</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>match_result <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="at">left =</span> left_data,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  <span class="at">right =</span> right_data,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;income&quot;</span>),</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">TRUE</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>)</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="co">#&gt; Auto-selected scaling method: standardize</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co"># Get matched samples</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>matched_left <span class="ot">&lt;-</span> left_data <span class="sc">%&gt;%</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> match_result<span class="sc">$</span>pairs<span class="sc">$</span>left_id)</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>matched_right <span class="ot">&lt;-</span> right_data <span class="sc">%&gt;%</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> match_result<span class="sc">$</span>pairs<span class="sc">$</span>right_id)</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="co"># Compute balance diagnostics</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>balance <span class="ot">&lt;-</span> <span class="fu">balance_diagnostics</span>(</span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>  <span class="at">result =</span> match_result,</span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>  <span class="at">left =</span> left_data,</span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a>  <span class="at">right =</span> right_data,</span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;income&quot;</span>)</span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>)</span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="co"># Print balance summary</span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="fu">print</span>(balance)</span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a><span class="co">#&gt; Balance Diagnostics for Matched Pairs</span></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a><span class="co">#&gt; ======================================</span></span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a><span class="co">#&gt; Matching Summary:</span></span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a><span class="co">#&gt;   Method: lap</span></span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a><span class="co">#&gt;   Matched pairs: 100</span></span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a><span class="co">#&gt;   Unmatched left: 0 (of 100)</span></span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a><span class="co">#&gt;   Unmatched right: 50 (of 150)</span></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a><span class="co">#&gt; Variable-level Balance:</span></span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 7</span></span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a><span class="co">#&gt;   Variable `Mean Left` `Mean Right` `Mean Diff` `Std Diff` `Var Ratio` `KS Stat`</span></span>
<span id="cb15-40"><a href="#cb15-40" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;          &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb15-41"><a href="#cb15-41" tabindex="-1"></a><span class="co">#&gt; 1 age             45.9         47.3       -1.43     -0.148       0.891      0.18</span></span>
<span id="cb15-42"><a href="#cb15-42" tabindex="-1"></a><span class="co">#&gt; 2 income       58387.       56118.      2269.        0.155       0.982      0.09</span></span>
<span id="cb15-43"><a href="#cb15-43" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-44"><a href="#cb15-44" tabindex="-1"></a><span class="co">#&gt; Overall Balance:</span></span>
<span id="cb15-45"><a href="#cb15-45" tabindex="-1"></a><span class="co">#&gt;   Mean |Std Diff|: 0.151 (Good)</span></span>
<span id="cb15-46"><a href="#cb15-46" tabindex="-1"></a><span class="co">#&gt;   Max |Std Diff|: 0.155</span></span>
<span id="cb15-47"><a href="#cb15-47" tabindex="-1"></a><span class="co">#&gt;   Vars with |Std Diff| &gt; 0.25: 0.0%</span></span>
<span id="cb15-48"><a href="#cb15-48" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-49"><a href="#cb15-49" tabindex="-1"></a><span class="co">#&gt; Balance Interpretation:</span></span>
<span id="cb15-50"><a href="#cb15-50" tabindex="-1"></a><span class="co">#&gt;   |Std Diff| &lt; 0.10: Excellent balance</span></span>
<span id="cb15-51"><a href="#cb15-51" tabindex="-1"></a><span class="co">#&gt;   |Std Diff| 0.10-0.25: Good balance</span></span>
<span id="cb15-52"><a href="#cb15-52" tabindex="-1"></a><span class="co">#&gt;   |Std Diff| 0.25-0.50: Acceptable balance</span></span>
<span id="cb15-53"><a href="#cb15-53" tabindex="-1"></a><span class="co">#&gt;   |Std Diff| &gt; 0.50: Poor balance</span></span>
<span id="cb15-54"><a href="#cb15-54" tabindex="-1"></a></span>
<span id="cb15-55"><a href="#cb15-55" tabindex="-1"></a><span class="co"># Extract balance table for reporting</span></span>
<span id="cb15-56"><a href="#cb15-56" tabindex="-1"></a><span class="fu">balance_table</span>(balance)</span>
<span id="cb15-57"><a href="#cb15-57" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 7</span></span>
<span id="cb15-58"><a href="#cb15-58" tabindex="-1"></a><span class="co">#&gt;   Variable `Mean Left` `Mean Right` `Mean Diff` `Std Diff` `Var Ratio` `KS Stat`</span></span>
<span id="cb15-59"><a href="#cb15-59" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;          &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb15-60"><a href="#cb15-60" tabindex="-1"></a><span class="co">#&gt; 1 age             45.9         47.3       -1.43     -0.148       0.891      0.18</span></span>
<span id="cb15-61"><a href="#cb15-61" tabindex="-1"></a><span class="co">#&gt; 2 income       58387.       56118.      2269.        0.155       0.982      0.09</span></span></code></pre></div>
</div>
<div id="how-to-interpret-balance-results" class="section level3">
<h3>How to Interpret Balance Results</h3>
<p>The balance diagnostics output tells you whether your match
succeeded. Here’s how to read it:</p>
<pre><code>Balance Diagnostics
-------------------
Variables: age, income

Variable Statistics:
  variable mean_left mean_right std_diff var_ratio ks_stat ks_p
  age      45.2      45.8       -0.08    0.95      0.06    0.89
  income   58000     56500      0.12     1.08      0.09    0.45</code></pre>
<p><strong>Reading each column</strong>:</p>
<table>
<colgroup>
<col width="26%" />
<col width="30%" />
<col width="43%" />
</colgroup>
<thead>
<tr class="header">
<th>Column</th>
<th>Meaning</th>
<th>Good Values</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>std_diff</code></td>
<td>Standardized difference in means</td>
<td>|value| &lt; 0.1 excellent, &lt; 0.25 acceptable</td>
</tr>
<tr class="even">
<td><code>var_ratio</code></td>
<td>Ratio of standard deviations</td>
<td>0.5–2.0 acceptable, closer to 1.0 is better</td>
</tr>
<tr class="odd">
<td><code>ks_stat</code></td>
<td>Kolmogorov-Smirnov statistic</td>
<td>Smaller is better</td>
</tr>
<tr class="even">
<td><code>ks_p</code></td>
<td>KS test p-value</td>
<td>&gt; 0.05 suggests similar distributions</td>
</tr>
</tbody>
</table>
<p><strong>Quality thresholds</strong> for standardized differences:</p>
<ul>
<li><p><strong>&lt; 0.1</strong>: Excellent balance (treat as
successfully matched)</p></li>
<li><p><strong>0.1-0.25</strong>: Good balance (acceptable for most
purposes)</p></li>
<li><p><strong>0.25-0.5</strong>: Marginal (consider refinement or
sensitivity analysis)</p></li>
<li><p><strong>&gt; 0.5</strong>: Poor balance (matching strategy needs
revision)</p></li>
</ul>
<p><strong>What to do if balance is poor</strong>:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Add more matching variables</strong> that explain the
imbalance</p></li>
<li><p><strong>Tighten calipers</strong> (accept fewer matches but
better quality)</p></li>
<li><p><strong>Try blocking</strong> on the problematic
variable</p></li>
<li><p><strong>Report and discuss</strong> in limitations
section</p></li>
</ol>
</div>
<div id="visualizing-balance" class="section level3">
<h3>Visualizing Balance</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># Before-after balance plot</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="co"># (Requires creating pre-match balance for comparison)</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co"># For pre-match comparison, just compute summary statistics directly</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>pre_match_stats <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;income&quot;</span>),</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>  <span class="at">std_diff =</span> <span class="fu">c</span>(</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>    (<span class="fu">mean</span>(left_data<span class="sc">$</span>age) <span class="sc">-</span> <span class="fu">mean</span>(right_data<span class="sc">$</span>age)) <span class="sc">/</span> <span class="fu">sqrt</span>((<span class="fu">sd</span>(left_data<span class="sc">$</span>age)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">sd</span>(right_data<span class="sc">$</span>age)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>    (<span class="fu">mean</span>(left_data<span class="sc">$</span>income) <span class="sc">-</span> <span class="fu">mean</span>(right_data<span class="sc">$</span>income)) <span class="sc">/</span> <span class="fu">sqrt</span>((<span class="fu">sd</span>(left_data<span class="sc">$</span>income)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">sd</span>(right_data<span class="sc">$</span>income)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>  ),</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>  <span class="at">when =</span> <span class="st">&quot;Before&quot;</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>)</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="co"># Combine for plotting</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>balance_comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>  pre_match_stats,</span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>  balance<span class="sc">$</span>var_stats <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(variable, std_diff) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">when =</span> <span class="st">&quot;After&quot;</span>)</span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>)</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="fu">ggplot</span>(balance_comparison, <span class="fu">aes</span>(<span class="at">x =</span> variable, <span class="at">y =</span> std_diff, <span class="at">fill =</span> when)) <span class="sc">+</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#93c54b&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.25</span>, <span class="fl">0.25</span>), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#f47c3c&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="at">width =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fl">1.5</span>, <span class="at">y =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">label =</span> <span class="st">&quot;±0.1 excellent&quot;</span>),</span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a>             <span class="at">fill =</span> <span class="st">&quot;#93c54b&quot;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">3</span>, <span class="at">fontface =</span> <span class="st">&quot;bold&quot;</span>, <span class="at">label.padding =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">&quot;lines&quot;</span>)) <span class="sc">+</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fl">1.5</span>, <span class="at">y =</span> <span class="fl">0.25</span>, <span class="at">label =</span> <span class="st">&quot;±0.25 acceptable&quot;</span>),</span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a>             <span class="at">fill =</span> <span class="st">&quot;#f47c3c&quot;</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">3</span>, <span class="at">fontface =</span> <span class="st">&quot;bold&quot;</span>, <span class="at">label.padding =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">&quot;lines&quot;</span>)) <span class="sc">+</span></span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Covariate Balance Before and After Matching&quot;</span>,</span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Variable&quot;</span>,</span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Standardized Difference&quot;</span>,</span>
<span id="cb17-34"><a href="#cb17-34" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;Timing&quot;</span></span>
<span id="cb17-35"><a href="#cb17-35" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb17-36"><a href="#cb17-36" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb17-37"><a href="#cb17-37" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb17-38"><a href="#cb17-38" tabindex="-1"></a>        <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb17-39"><a href="#cb17-39" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb17-40"><a href="#cb17-40" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb17-41"><a href="#cb17-41" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span>
<span id="cb17-42"><a href="#cb17-42" tabindex="-1"></a><span class="co">#&gt; Warning in geom_label(aes(x = 1.5, y = -0.1, label = &quot;±0.1 excellent&quot;), : All aesthetics have length 1, but the data has 4 rows.</span></span>
<span id="cb17-43"><a href="#cb17-43" tabindex="-1"></a><span class="co">#&gt; ℹ Please consider using `annotate()` or provide this layer with data containing</span></span>
<span id="cb17-44"><a href="#cb17-44" tabindex="-1"></a><span class="co">#&gt;   a single row.</span></span>
<span id="cb17-45"><a href="#cb17-45" tabindex="-1"></a><span class="co">#&gt; Warning in geom_label(aes(x = 1.5, y = 0.25, label = &quot;±0.25 acceptable&quot;), : All aesthetics have length 1, but the data has 4 rows.</span></span>
<span id="cb17-46"><a href="#cb17-46" tabindex="-1"></a><span class="co">#&gt; ℹ Please consider using `annotate()` or provide this layer with data containing</span></span>
<span id="cb17-47"><a href="#cb17-47" tabindex="-1"></a><span class="co">#&gt;   a single row.</span></span></code></pre></div>
<p><img role="img" aria-label="Bar chart comparing standardized differences before and after matching, with threshold lines at 0.1 and 0.25 showing improved balance after matching" src="data:image/png;base64,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" alt="Bar chart comparing standardized differences before and after matching, with threshold lines at 0.1 and 0.25 showing improved balance after matching" /></p>
</div>
</div>
<div id="real-world-example-treatment-effect-estimation" class="section level2">
<h2>Real-World Example: Treatment Effect Estimation</h2>
<p>Complete workflow for estimating treatment effects in an
observational study.</p>
<div id="scenario" class="section level3">
<h3>Scenario</h3>
<p>Evaluate the effect of a job training program on earnings.
Participants self-selected into the program, creating potential
selection bias.</p>
<p><strong>Data:</strong></p>
<ul>
<li><p>Treatment: 200 program participants</p></li>
<li><p>Control: 500 non-participants</p></li>
<li><p>Covariates: age, education, prior earnings, employment
status</p></li>
<li><p>Outcome: Earnings one year after program</p></li>
</ul>
</div>
<div id="step-1-data-preparation" class="section level3">
<h3>Step 1: Data Preparation</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">404</span>)</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="co"># Simulate realistic scenario with selection bias</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="co"># Program attracts younger, more educated, currently employed individuals</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>create_participant <span class="ot">&lt;-</span> <span class="cf">function</span>(n, is_treatment) {</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>  <span class="cf">if</span> (is_treatment) {</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>      <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>      <span class="at">age =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">35</span>, <span class="at">sd =</span> <span class="dv">8</span>),</span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>      <span class="at">education_years =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">14</span>, <span class="at">sd =</span> <span class="dv">2</span>),</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>      <span class="at">prior_earnings =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">35000</span>, <span class="at">sd =</span> <span class="dv">10000</span>),</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>      <span class="at">employed =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), n, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.7</span>)),</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>      <span class="at">treatment =</span> <span class="dv">1</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>    )</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>      <span class="at">id =</span> (n<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(n<span class="sc">+</span><span class="dv">500</span>),</span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>      <span class="at">age =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="at">mean =</span> <span class="dv">42</span>, <span class="at">sd =</span> <span class="dv">12</span>),</span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a>      <span class="at">education_years =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="at">mean =</span> <span class="dv">12</span>, <span class="at">sd =</span> <span class="dv">3</span>),</span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a>      <span class="at">prior_earnings =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="at">mean =</span> <span class="dv">30000</span>, <span class="at">sd =</span> <span class="dv">12000</span>),</span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a>      <span class="at">employed =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dv">500</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)),</span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a>      <span class="at">treatment =</span> <span class="dv">0</span></span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a>    )</span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a>  }</span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a>}</span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a>treatment_group <span class="ot">&lt;-</span> <span class="fu">create_participant</span>(<span class="dv">200</span>, <span class="cn">TRUE</span>)</span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a>control_group <span class="ot">&lt;-</span> <span class="fu">create_participant</span>(<span class="dv">500</span>, <span class="cn">FALSE</span>)</span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" tabindex="-1"></a><span class="co"># Simulate outcome (earnings) with treatment effect</span></span>
<span id="cb18-31"><a href="#cb18-31" tabindex="-1"></a><span class="co"># True effect: +$5,000, with heterogeneity</span></span>
<span id="cb18-32"><a href="#cb18-32" tabindex="-1"></a>treatment_group <span class="ot">&lt;-</span> treatment_group <span class="sc">%&gt;%</span></span>
<span id="cb18-33"><a href="#cb18-33" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-34"><a href="#cb18-34" tabindex="-1"></a>    <span class="at">earnings =</span> prior_earnings <span class="sc">+</span></span>
<span id="cb18-35"><a href="#cb18-35" tabindex="-1"></a>      <span class="dv">5000</span> <span class="sc">+</span>  <span class="co"># True treatment effect</span></span>
<span id="cb18-36"><a href="#cb18-36" tabindex="-1"></a>      <span class="dv">2000</span> <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="fu">n</span>()) <span class="sc">+</span>  <span class="co"># Random variation</span></span>
<span id="cb18-37"><a href="#cb18-37" tabindex="-1"></a>      <span class="dv">100</span> <span class="sc">*</span> education_years  <span class="co"># Education effect</span></span>
<span id="cb18-38"><a href="#cb18-38" tabindex="-1"></a>  )</span>
<span id="cb18-39"><a href="#cb18-39" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" tabindex="-1"></a>control_group <span class="ot">&lt;-</span> control_group <span class="sc">%&gt;%</span></span>
<span id="cb18-41"><a href="#cb18-41" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-42"><a href="#cb18-42" tabindex="-1"></a>    <span class="at">earnings =</span> prior_earnings <span class="sc">+</span></span>
<span id="cb18-43"><a href="#cb18-43" tabindex="-1"></a>      <span class="dv">2000</span> <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="fu">n</span>()) <span class="sc">+</span></span>
<span id="cb18-44"><a href="#cb18-44" tabindex="-1"></a>      <span class="dv">100</span> <span class="sc">*</span> education_years</span>
<span id="cb18-45"><a href="#cb18-45" tabindex="-1"></a>  )</span>
<span id="cb18-46"><a href="#cb18-46" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" tabindex="-1"></a><span class="co"># Examine baseline imbalance</span></span>
<span id="cb18-48"><a href="#cb18-48" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Pre-matching differences:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb18-49"><a href="#cb18-49" tabindex="-1"></a><span class="co">#&gt; Pre-matching differences:</span></span>
<span id="cb18-50"><a href="#cb18-50" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Age diff:&quot;</span>,</span>
<span id="cb18-51"><a href="#cb18-51" tabindex="-1"></a>    <span class="fu">mean</span>(treatment_group<span class="sc">$</span>age) <span class="sc">-</span> <span class="fu">mean</span>(control_group<span class="sc">$</span>age), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb18-52"><a href="#cb18-52" tabindex="-1"></a><span class="co">#&gt; Age diff: -5.525329</span></span>
<span id="cb18-53"><a href="#cb18-53" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Education diff:&quot;</span>,</span>
<span id="cb18-54"><a href="#cb18-54" tabindex="-1"></a>    <span class="fu">mean</span>(treatment_group<span class="sc">$</span>education_years) <span class="sc">-</span> <span class="fu">mean</span>(control_group<span class="sc">$</span>education_years), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb18-55"><a href="#cb18-55" tabindex="-1"></a><span class="co">#&gt; Education diff: 1.801605</span></span>
<span id="cb18-56"><a href="#cb18-56" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Prior earnings diff:&quot;</span>,</span>
<span id="cb18-57"><a href="#cb18-57" tabindex="-1"></a>    <span class="fu">mean</span>(treatment_group<span class="sc">$</span>prior_earnings) <span class="sc">-</span> <span class="fu">mean</span>(control_group<span class="sc">$</span>prior_earnings), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb18-58"><a href="#cb18-58" tabindex="-1"></a><span class="co">#&gt; Prior earnings diff: 5420.931</span></span></code></pre></div>
</div>
<div id="step-2-perform-matching" class="section level3">
<h3>Step 2: Perform Matching</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># Match on baseline covariates</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>job_match <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  <span class="at">left =</span> treatment_group,</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>  <span class="at">right =</span> control_group,</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;education_years&quot;</span>, <span class="st">&quot;prior_earnings&quot;</span>, <span class="st">&quot;employed&quot;</span>),</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>  <span class="at">scale =</span> <span class="st">&quot;robust&quot;</span>,</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>  <span class="at">return_diagnostics =</span> <span class="cn">TRUE</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>)</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Matching summary:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a><span class="co">#&gt; Matching summary:</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Treated units:&quot;</span>, <span class="fu">nrow</span>(treatment_group), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a><span class="co">#&gt;   Treated units: 200</span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Matched treated:&quot;</span>, job_match<span class="sc">$</span>info<span class="sc">$</span>n_matched, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a><span class="co">#&gt;   Matched treated: 200</span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Match rate:&quot;</span>,</span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>    <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> job_match<span class="sc">$</span>info<span class="sc">$</span>n_matched <span class="sc">/</span> <span class="fu">nrow</span>(treatment_group), <span class="dv">1</span>), <span class="st">&quot;%</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a><span class="co">#&gt;   Match rate: 100 %</span></span></code></pre></div>
</div>
<div id="step-3-assess-balance" class="section level3">
<h3>Step 3: Assess Balance</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># Extract matched samples</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>matched_treated <span class="ot">&lt;-</span> treatment_group <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> job_match<span class="sc">$</span>pairs<span class="sc">$</span>left_id)</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>matched_control <span class="ot">&lt;-</span> control_group <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> job_match<span class="sc">$</span>pairs<span class="sc">$</span>right_id)</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="co"># Compute balance</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>job_balance <span class="ot">&lt;-</span> <span class="fu">balance_diagnostics</span>(</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>  <span class="at">result =</span> job_match,</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>  <span class="at">left =</span> treatment_group,</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>  <span class="at">right =</span> control_group,</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;education_years&quot;</span>, <span class="st">&quot;prior_earnings&quot;</span>, <span class="st">&quot;employed&quot;</span>)</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>)</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a><span class="co">#&gt; Warning in ks.test.default(left_clean, right_clean): p-value will be</span></span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a><span class="co">#&gt; approximate in the presence of ties</span></span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a><span class="fu">print</span>(job_balance)</span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a><span class="co">#&gt; Balance Diagnostics for Matched Pairs</span></span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a><span class="co">#&gt; ======================================</span></span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a><span class="co">#&gt; Matching Summary:</span></span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a><span class="co">#&gt;   Method: lap</span></span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a><span class="co">#&gt;   Matched pairs: 200</span></span>
<span id="cb20-26"><a href="#cb20-26" tabindex="-1"></a><span class="co">#&gt;   Unmatched left: 0 (of 200)</span></span>
<span id="cb20-27"><a href="#cb20-27" tabindex="-1"></a><span class="co">#&gt;   Unmatched right: 300 (of 500)</span></span>
<span id="cb20-28"><a href="#cb20-28" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb20-29"><a href="#cb20-29" tabindex="-1"></a><span class="co">#&gt; Variable-level Balance:</span></span>
<span id="cb20-30"><a href="#cb20-30" tabindex="-1"></a><span class="co">#&gt; # A tibble: 4 × 7</span></span>
<span id="cb20-31"><a href="#cb20-31" tabindex="-1"></a><span class="co">#&gt;   Variable `Mean Left` `Mean Right` `Mean Diff` `Std Diff` `Var Ratio` `KS Stat`</span></span>
<span id="cb20-32"><a href="#cb20-32" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;          &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb20-33"><a href="#cb20-33" tabindex="-1"></a><span class="co">#&gt; 1 age             35.4       36.0        -0.656     -0.081       0.869     0.1  </span></span>
<span id="cb20-34"><a href="#cb20-34" tabindex="-1"></a><span class="co">#&gt; 2 educati…        13.9       13.5         0.4        0.195       0.93      0.18 </span></span>
<span id="cb20-35"><a href="#cb20-35" tabindex="-1"></a><span class="co">#&gt; 3 prior_e…     35015.     33795.       1219.         0.121       1.01      0.08 </span></span>
<span id="cb20-36"><a href="#cb20-36" tabindex="-1"></a><span class="co">#&gt; 4 employed         0.7        0.635       0.065      0.138       0.952     0.065</span></span>
<span id="cb20-37"><a href="#cb20-37" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb20-38"><a href="#cb20-38" tabindex="-1"></a><span class="co">#&gt; Overall Balance:</span></span>
<span id="cb20-39"><a href="#cb20-39" tabindex="-1"></a><span class="co">#&gt;   Mean |Std Diff|: 0.134 (Good)</span></span>
<span id="cb20-40"><a href="#cb20-40" tabindex="-1"></a><span class="co">#&gt;   Max |Std Diff|: 0.195</span></span>
<span id="cb20-41"><a href="#cb20-41" tabindex="-1"></a><span class="co">#&gt;   Vars with |Std Diff| &gt; 0.25: 0.0%</span></span>
<span id="cb20-42"><a href="#cb20-42" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb20-43"><a href="#cb20-43" tabindex="-1"></a><span class="co">#&gt; Balance Interpretation:</span></span>
<span id="cb20-44"><a href="#cb20-44" tabindex="-1"></a><span class="co">#&gt;   |Std Diff| &lt; 0.10: Excellent balance</span></span>
<span id="cb20-45"><a href="#cb20-45" tabindex="-1"></a><span class="co">#&gt;   |Std Diff| 0.10-0.25: Good balance</span></span>
<span id="cb20-46"><a href="#cb20-46" tabindex="-1"></a><span class="co">#&gt;   |Std Diff| 0.25-0.50: Acceptable balance</span></span>
<span id="cb20-47"><a href="#cb20-47" tabindex="-1"></a><span class="co">#&gt;   |Std Diff| &gt; 0.50: Poor balance</span></span>
<span id="cb20-48"><a href="#cb20-48" tabindex="-1"></a></span>
<span id="cb20-49"><a href="#cb20-49" tabindex="-1"></a><span class="co"># Check overall balance quality</span></span>
<span id="cb20-50"><a href="#cb20-50" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Overall balance:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb20-51"><a href="#cb20-51" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb20-52"><a href="#cb20-52" tabindex="-1"></a><span class="co">#&gt; Overall balance:</span></span>
<span id="cb20-53"><a href="#cb20-53" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Mean |std diff|:&quot;</span>, <span class="fu">round</span>(job_balance<span class="sc">$</span>overall<span class="sc">$</span>mean_abs_std_diff, <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb20-54"><a href="#cb20-54" tabindex="-1"></a><span class="co">#&gt;   Mean |std diff|: 0.134</span></span>
<span id="cb20-55"><a href="#cb20-55" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Max |std diff|:&quot;</span>, <span class="fu">round</span>(job_balance<span class="sc">$</span>overall<span class="sc">$</span>max_abs_std_diff, <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb20-56"><a href="#cb20-56" tabindex="-1"></a><span class="co">#&gt;   Max |std diff|: 0.195</span></span>
<span id="cb20-57"><a href="#cb20-57" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  % with |std diff| &gt; 0.1:&quot;</span>,</span>
<span id="cb20-58"><a href="#cb20-58" tabindex="-1"></a>    <span class="fu">round</span>(job_balance<span class="sc">$</span>overall<span class="sc">$</span>pct_large_imbalance, <span class="dv">1</span>), <span class="st">&quot;%</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb20-59"><a href="#cb20-59" tabindex="-1"></a><span class="co">#&gt;   % with |std diff| &gt; 0.1: 0 %</span></span></code></pre></div>
</div>
<div id="step-4-estimate-treatment-effect" class="section level3">
<h3>Step 4: Estimate Treatment Effect</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># Naive estimate (without matching) - BIASED</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>naive_effect <span class="ot">&lt;-</span> <span class="fu">mean</span>(treatment_group<span class="sc">$</span>earnings) <span class="sc">-</span> <span class="fu">mean</span>(control_group<span class="sc">$</span>earnings)</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="co"># Matched estimate - accounts for baseline differences</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>matched_effect <span class="ot">&lt;-</span> <span class="fu">mean</span>(matched_treated<span class="sc">$</span>earnings) <span class="sc">-</span> <span class="fu">mean</span>(matched_control<span class="sc">$</span>earnings)</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="co"># Paired t-test for significance</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>paired_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>  <span class="at">treated =</span> matched_treated<span class="sc">$</span>earnings,</span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>  <span class="at">control =</span> matched_control<span class="sc">$</span>earnings[<span class="fu">match</span>(</span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>    matched_treated<span class="sc">$</span>id,</span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>    job_match<span class="sc">$</span>pairs<span class="sc">$</span>left_id</span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>  )]</span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>)</span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>t_test <span class="ot">&lt;-</span> <span class="fu">t.test</span>(paired_comparison<span class="sc">$</span>treated, paired_comparison<span class="sc">$</span>control, <span class="at">paired =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a><span class="co"># Report results</span></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Treatment Effect Estimates:</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a><span class="co">#&gt; Treatment Effect Estimates:</span></span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Naive (unmatched):</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a><span class="co">#&gt; Naive (unmatched):</span></span>
<span id="cb21-23"><a href="#cb21-23" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Difference: $&quot;</span>, <span class="fu">round</span>(naive_effect, <span class="dv">0</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb21-24"><a href="#cb21-24" tabindex="-1"></a><span class="co">#&gt;   Difference: $ 10680</span></span>
<span id="cb21-25"><a href="#cb21-25" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  (Upward biased due to selection)</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span>
<span id="cb21-26"><a href="#cb21-26" tabindex="-1"></a><span class="co">#&gt;   (Upward biased due to selection)</span></span>
<span id="cb21-27"><a href="#cb21-27" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Matched estimate:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb21-29"><a href="#cb21-29" tabindex="-1"></a><span class="co">#&gt; Matched estimate:</span></span>
<span id="cb21-30"><a href="#cb21-30" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  Difference: $&quot;</span>, <span class="fu">round</span>(matched_effect, <span class="dv">0</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb21-31"><a href="#cb21-31" tabindex="-1"></a><span class="co">#&gt;   Difference: $ 6276</span></span>
<span id="cb21-32"><a href="#cb21-32" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  95% CI: ($&quot;</span>, <span class="fu">round</span>(t_test<span class="sc">$</span>conf.int[<span class="dv">1</span>], <span class="dv">0</span>), <span class="st">&quot;, $&quot;</span>,</span>
<span id="cb21-33"><a href="#cb21-33" tabindex="-1"></a>    <span class="fu">round</span>(t_test<span class="sc">$</span>conf.int[<span class="dv">2</span>], <span class="dv">0</span>), <span class="st">&quot;)</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb21-34"><a href="#cb21-34" tabindex="-1"></a><span class="co">#&gt;   95% CI: ($ 4301 , $ 8252 )</span></span>
<span id="cb21-35"><a href="#cb21-35" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  P-value:&quot;</span>, <span class="fu">format.pval</span>(t_test<span class="sc">$</span>p.value, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb21-36"><a href="#cb21-36" tabindex="-1"></a><span class="co">#&gt;   P-value: 2.26e-09</span></span>
<span id="cb21-37"><a href="#cb21-37" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  (Closer to true effect of $5,000)</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb21-38"><a href="#cb21-38" tabindex="-1"></a><span class="co">#&gt;   (Closer to true effect of $5,000)</span></span></code></pre></div>
</div>
<div id="step-5-publication-ready-output" class="section level3">
<h3>Step 5: Publication-Ready Output</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># Table 1: Balance table</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>balance_publication <span class="ot">&lt;-</span> <span class="fu">balance_table</span>(job_balance)</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="fu">print</span>(balance_publication)</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="co"># Table 2: Sample characteristics</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>sample_table <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>  matched_treated <span class="sc">%&gt;%</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>      <span class="at">Group =</span> <span class="st">&quot;Treatment&quot;</span>,</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>      <span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>      <span class="st">`</span><span class="at">Age (mean ± SD)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.1f ± %.1f&quot;</span>, <span class="fu">mean</span>(age), <span class="fu">sd</span>(age)),</span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a>      <span class="st">`</span><span class="at">Education (years)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.1f ± %.1f&quot;</span>, <span class="fu">mean</span>(education_years), <span class="fu">sd</span>(education_years)),</span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>      <span class="st">`</span><span class="at">Prior Earnings</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">&quot;$%s ± %s&quot;</span>,</span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>                                 <span class="fu">format</span>(<span class="fu">round</span>(<span class="fu">mean</span>(prior_earnings)), <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>),</span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a>                                 <span class="fu">format</span>(<span class="fu">round</span>(<span class="fu">sd</span>(prior_earnings)), <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>)),</span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a>      <span class="st">`</span><span class="at">Employed (%)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, <span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(employed))</span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a>    ),</span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a>  matched_control <span class="sc">%&gt;%</span></span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a>      <span class="at">Group =</span> <span class="st">&quot;Control&quot;</span>,</span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a>      <span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a>      <span class="st">`</span><span class="at">Age (mean ± SD)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.1f ± %.1f&quot;</span>, <span class="fu">mean</span>(age), <span class="fu">sd</span>(age)),</span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a>      <span class="st">`</span><span class="at">Education (years)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.1f ± %.1f&quot;</span>, <span class="fu">mean</span>(education_years), <span class="fu">sd</span>(education_years)),</span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a>      <span class="st">`</span><span class="at">Prior Earnings</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">&quot;$%s ± %s&quot;</span>,</span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a>                                 <span class="fu">format</span>(<span class="fu">round</span>(<span class="fu">mean</span>(prior_earnings)), <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>),</span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a>                                 <span class="fu">format</span>(<span class="fu">round</span>(<span class="fu">sd</span>(prior_earnings)), <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>)),</span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a>      <span class="st">`</span><span class="at">Employed (%)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, <span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(employed))</span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a>    )</span>
<span id="cb22-29"><a href="#cb22-29" tabindex="-1"></a>)</span>
<span id="cb22-30"><a href="#cb22-30" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" tabindex="-1"></a><span class="fu">print</span>(sample_table)</span>
<span id="cb22-32"><a href="#cb22-32" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" tabindex="-1"></a><span class="co"># Table 3: Treatment effect</span></span>
<span id="cb22-34"><a href="#cb22-34" tabindex="-1"></a>effect_table <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb22-35"><a href="#cb22-35" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">&quot;Unmatched&quot;</span>, <span class="st">&quot;Matched&quot;</span>),</span>
<span id="cb22-36"><a href="#cb22-36" tabindex="-1"></a>  <span class="st">`</span><span class="at">N (Treated)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">nrow</span>(treatment_group), <span class="fu">nrow</span>(matched_treated)),</span>
<span id="cb22-37"><a href="#cb22-37" tabindex="-1"></a>  <span class="st">`</span><span class="at">N (Control)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">nrow</span>(control_group), <span class="fu">nrow</span>(matched_control)),</span>
<span id="cb22-38"><a href="#cb22-38" tabindex="-1"></a>  <span class="st">`</span><span class="at">Effect Estimate</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">&quot;$%s&quot;</span>, <span class="fu">format</span>(<span class="fu">round</span>(<span class="fu">c</span>(naive_effect, matched_effect)), <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>)),</span>
<span id="cb22-39"><a href="#cb22-39" tabindex="-1"></a>  <span class="st">`</span><span class="at">95% CI</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;--&quot;</span>, <span class="fu">sprintf</span>(<span class="st">&quot;($%s, $%s)&quot;</span>,</span>
<span id="cb22-40"><a href="#cb22-40" tabindex="-1"></a>                            <span class="fu">format</span>(<span class="fu">round</span>(t_test<span class="sc">$</span>conf.int[<span class="dv">1</span>]), <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>),</span>
<span id="cb22-41"><a href="#cb22-41" tabindex="-1"></a>                            <span class="fu">format</span>(<span class="fu">round</span>(t_test<span class="sc">$</span>conf.int[<span class="dv">2</span>]), <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>)))</span>
<span id="cb22-42"><a href="#cb22-42" tabindex="-1"></a>)</span>
<span id="cb22-43"><a href="#cb22-43" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" tabindex="-1"></a><span class="fu">print</span>(effect_table)</span></code></pre></div>
</div>
</div>
<div id="performance-considerations" class="section level2">
<h2>Performance Considerations</h2>
<div id="scalability" class="section level3">
<h3>Scalability</h3>
<p><strong>Optimal matching complexity:</strong> <span class="math inline">\(O(n^3)\)</span> using Jonker-Volgenant</p>
<ul>
<li><p>n = 100: &lt; 0.01 seconds</p></li>
<li><p>n = 500: ~ 0.1 seconds</p></li>
<li><p>n = 1,000: ~ 1 second</p></li>
<li><p>n = 3,000: ~ 10 seconds</p></li>
<li><p>n = 5,000: ~ 30-60 seconds</p></li>
</ul>
<p><strong>Greedy matching complexity:</strong> <span class="math inline">\(O(n^2 \log n)\)</span> for sorted, <span class="math inline">\(O(n^2)\)</span> for row-best</p>
<ul>
<li><p>n = 5,000: ~ 1 second</p></li>
<li><p>n = 10,000: ~ 3-5 seconds</p></li>
<li><p>n = 50,000: ~ 30-60 seconds</p></li>
</ul>
</div>
<div id="memory-usage" class="section level3">
<h3>Memory Usage</h3>
<ul>
<li><p>Cost matrix: 8n² bytes (for n×n problem)</p></li>
<li><p>n = 1,000: ~ 8 MB</p></li>
<li><p>n = 5,000: ~ 200 MB</p></li>
<li><p>n = 10,000: ~ 800 MB</p></li>
</ul>
<p>For very large problems:</p>
<ol style="list-style-type: decimal">
<li><p>Use greedy matching to avoid full cost matrix</p></li>
<li><p>Use blocking to reduce within-block size</p></li>
<li><p>Consider approximate methods (upcoming vignette)</p></li>
</ol>
</div>
<div id="optimization-tips" class="section level3">
<h3>Optimization Tips</h3>
<p><strong>1. Use blocking for large datasets</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># Instead of matching 10,000 × 10,000:</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="co"># Create 10 blocks of ~1,000 × 1,000 each</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>blocks <span class="ot">&lt;-</span> <span class="fu">matchmaker</span>(</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>  left_large, right_large,</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>  <span class="at">block_type =</span> <span class="st">&quot;cluster&quot;</span>,</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>  <span class="at">cluster_vars =</span> <span class="st">&quot;age&quot;</span>,</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>  <span class="at">n_clusters =</span> <span class="dv">10</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>)</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a><span class="co"># Much faster: 10 * O(1000^3) &lt;&lt; O(10000^3)</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>  blocks<span class="sc">$</span>left, blocks<span class="sc">$</span>right,</span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>  <span class="at">vars =</span> covariates,</span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>  <span class="at">block_id =</span> <span class="st">&quot;block_id&quot;</span></span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a>)</span></code></pre></div>
<p><strong>2. Start with greedy, refine if needed</strong></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># Quick greedy match for exploration</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>quick <span class="ot">&lt;-</span> <span class="fu">greedy_couples</span>(</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  left_data, right_data,</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>  <span class="at">vars =</span> covariates,</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>  <span class="at">strategy =</span> <span class="st">&quot;row_best&quot;</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>)</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a><span class="co"># Assess balance</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>balance_quick <span class="ot">&lt;-</span> <span class="fu">balance_diagnostics</span>(quick, left_data, right_data, <span class="at">vars =</span> covariates)</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a><span class="co"># If balance is acceptable, done!</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a><span class="co"># If not, try optimal or add blocking</span></span></code></pre></div>
<p><strong>3. Use calipers to reduce problem size</strong></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># Caliper removes distant pairs from cost matrix</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="co"># Can dramatically reduce effective problem size</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>  left_data, right_data,</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>  <span class="at">vars =</span> covariates,</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>  <span class="at">max_distance =</span> <span class="fl">0.25</span>,  <span class="co"># Strict caliper</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>  <span class="at">auto_scale =</span> <span class="cn">TRUE</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div id="what-can-go-wrong" class="section level2">
<h2>What Can Go Wrong</h2>
<p>Matching doesn’t always succeed. Here are common problems and
solutions.</p>
<div id="problem-poor-balance-despite-matching" class="section level3">
<h3>Problem: Poor Balance Despite Matching</h3>
<p><strong>Symptom</strong>: <code>balance_diagnostics()</code> shows
|std_diff| &gt; 0.25 for some variables.</p>
<p><strong>Causes</strong>: - Groups are fundamentally too different
(weak overlap)</p>
<ul>
<li><p>Important confounders not included in matching variables</p></li>
<li><p>Caliper too loose</p></li>
</ul>
<p><strong>Solutions</strong>:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># 1. Add more matching variables</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(left, right,</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>                        <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;income&quot;</span>, <span class="st">&quot;education&quot;</span>, <span class="st">&quot;region&quot;</span>),  <span class="co"># Added!</span></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>                        <span class="at">auto_scale =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a><span class="co"># 2. Tighten caliper (fewer but better matches)</span></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(left, right, <span class="at">vars =</span> vars,</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>                        <span class="at">max_distance =</span> <span class="fl">0.1</span>)  <span class="co"># Was 0.5</span></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a><span class="co"># 3. Block on the problematic variable</span></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>blocks <span class="ot">&lt;-</span> <span class="fu">matchmaker</span>(left, right, <span class="at">block_type =</span> <span class="st">&quot;group&quot;</span>, <span class="at">block_by =</span> <span class="st">&quot;region&quot;</span>)</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(blocks<span class="sc">$</span>left, blocks<span class="sc">$</span>right, <span class="at">vars =</span> other_vars,</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>                        <span class="at">block_id =</span> <span class="st">&quot;block_id&quot;</span>)</span></code></pre></div>
</div>
<div id="problem-very-few-matches" class="section level3">
<h3>Problem: Very Few Matches</h3>
<p><strong>Symptom</strong>: <code>n_matched</code> is much smaller than
<code>nrow(left)</code>.</p>
<p><strong>Causes</strong>: - Caliper too strict</p>
<ul>
<li><p>Non-overlapping covariate distributions</p></li>
<li><p>Blocking creates small strata</p></li>
</ul>
<p><strong>Diagnosis</strong>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="co"># Check covariate overlap</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a>combined <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a>  left <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">&quot;treatment&quot;</span>),</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>  right <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">&quot;control&quot;</span>)</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a>)</span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a><span class="fu">ggplot</span>(combined, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">fill =</span> group)) <span class="sc">+</span></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Check for Overlap&quot;</span>)</span></code></pre></div>
<p><strong>Solutions</strong>: - Relax caliper</p>
<ul>
<li><p>Use coarser blocking categories</p></li>
<li><p>Accept that some treatment units are unmatchable (report
this!)</p></li>
</ul>
</div>
<div id="problem-matching-takes-too-long" class="section level3">
<h3>Problem: Matching Takes Too Long</h3>
<p><strong>Symptom</strong>: <code>match_couples()</code> runs for
minutes or doesn’t complete. <strong>Cause</strong>: <span class="math inline">\(O(n^3)\)</span> complexity for optimal
matching.</p>
<p><strong>Solutions</strong>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># For n &gt; 3000: use greedy</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">greedy_couples</span>(left, right, <span class="at">vars =</span> vars, <span class="at">strategy =</span> <span class="st">&quot;sorted&quot;</span>)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="co"># For n &gt; 5000: add blocking</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>blocks <span class="ot">&lt;-</span> <span class="fu">matchmaker</span>(left, right, <span class="at">block_type =</span> <span class="st">&quot;cluster&quot;</span>, <span class="at">n_blocks =</span> <span class="dv">20</span>)</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">match_couples</span>(blocks<span class="sc">$</span>left, blocks<span class="sc">$</span>right, <span class="at">vars =</span> vars,</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>                        <span class="at">block_id =</span> <span class="st">&quot;block_id&quot;</span>)</span></code></pre></div>
</div>
<div id="problem-memory-error" class="section level3">
<h3>Problem: Memory Error</h3>
<p><strong>Symptom</strong>: R crashes or reports “cannot allocate
vector of size X”.</p>
<p><strong>Cause</strong>: Full cost matrix doesn’t fit in RAM. A
10,000×10,000 matrix needs ~800 MB.</p>
<p><strong>Solutions</strong>: - Use <code>greedy_couples()</code> which
doesn’t require full matrix</p>
<ul>
<li><p>Use blocking to create smaller sub-problems</p></li>
<li><p>Consider random sampling if sample size permits</p></li>
</ul>
</div>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<p>This vignette walked through a complete matching workflow using the
job training evaluation example:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Problem framing</strong>: Treatment effect estimation
with selection bias</p></li>
<li><p><strong>Matching</strong>: Creating comparable groups with
<code>match_couples()</code></p></li>
<li><p><strong>Preprocessing</strong>: Automatic scaling and variable
health checks</p></li>
<li><p><strong>Assessment</strong>: Balance diagnostics and
interpretation</p></li>
<li><p><strong>Refinement</strong>: Calipers, blocking, and greedy
alternatives</p></li>
<li><p><strong>Estimation</strong>: Treatment effect with confidence
intervals</p></li>
</ol>
<p><strong>Key Takeaways</strong>:</p>
<table>
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<thead>
<tr class="header">
<th>Concept</th>
<th>Key Point</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Preprocessing</td>
<td>Always use <code>auto_scale = TRUE</code> unless you have a specific
reason not to</td>
</tr>
<tr class="even">
<td>Balance</td>
<td>Target |std_diff| &lt; 0.1; accept &lt; 0.25</td>
</tr>
<tr class="odd">
<td>Calipers</td>
<td>Start loose, tighten if needed for balance</td>
</tr>
<tr class="even">
<td>Blocking</td>
<td>Use for exact balance on key categorical variables</td>
</tr>
<tr class="odd">
<td>Greedy</td>
<td>Use for n &gt; 3000; almost as good, much faster</td>
</tr>
</tbody>
</table>
<p><strong>Recommended Workflow</strong>:</p>
<p><img role="img" aria-label="Flowchart showing recommended matching workflow with iterative refinement loop" src="data:image/png;base64,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" alt="Flowchart showing recommended matching workflow with iterative refinement loop" /></p>
<hr />
</div>
<div id="see-also" class="section level2">
<h2>See Also</h2>
<ul>
<li><p><code>vignette(&quot;getting-started&quot;)</code> - Basic LAP
solving</p></li>
<li><p><code>vignette(&quot;algorithms&quot;)</code> - Mathematical
foundations</p></li>
<li><p><code>vignette(&quot;comparison&quot;)</code> - How couplr compares to
MatchIt, optmatch, designmatch</p></li>
<li><p><code>vignette(&quot;troubleshooting&quot;)</code> - Common issues and
solutions</p></li>
<li><p><code>vignette(&quot;pixel-morphing&quot;)</code> - Large-scale
approximation strategies</p></li>
<li><p><code>?match_couples</code>, <code>?greedy_couples</code>,
<code>?balance_diagnostics</code>, <code>?matchmaker</code></p></li>
</ul>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
